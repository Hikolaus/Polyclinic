@model List<ClinicApp.Models.Core.Appointment>
@{
    ViewData["Title"] = "Мои записи";
    string currentTab = ViewBag.CurrentTab as string ?? "upcoming";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-calendar-check me-2"></i>Мои записи</h2>
        <a href="/Patient/CreateAppointment" class="btn btn-primary shadow-sm">
            <i class="fas fa-plus me-1"></i> Записаться к врачу
        </a>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light p-0">
            <ul class="nav nav-tabs card-header-tabs m-0">
                <li class="nav-item">
                    <a class="nav-link py-3 px-4 border-top-0 border-start-0 @(currentTab == "upcoming" ? "active fw-bold text-primary" : "text-muted")"
                       href="?tab=upcoming">
                        <i class="fas fa-hourglass-half me-2"></i>Предстоящие
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link py-3 px-4 border-top-0 @(currentTab == "history" ? "active fw-bold text-secondary" : "text-muted")"
                       href="?tab=history">
                        <i class="fas fa-history me-2"></i>История и Архив
                    </a>
                </li>
            </ul>
        </div>

        <div class="card-body bg-light border-bottom">
            <form method="get" class="row g-2 align-items-center">
                <input type="hidden" name="tab" value="@currentTab" />
                <div class="col-auto">
                    <span class="fw-bold text-muted small text-uppercase">Фильтр по дате:</span>
                </div>
                <div class="col-auto">
                    <input type="date" name="startDate" class="form-control form-control-sm" value="@ViewBag.StartDate" placeholder="С..." title="Дата начала">
                </div>
                <div class="col-auto text-muted">-</div>
                <div class="col-auto">
                    <input type="date" name="endDate" class="form-control form-control-sm" value="@ViewBag.EndDate" placeholder="По..." title="Дата окончания">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-sm btn-outline-primary">Показать</button>
                    <a href="?tab=@currentTab" class="btn btn-sm btn-link text-decoration-none text-muted">Сброс</a>
                </div>
            </form>
        </div>

        <div class="card-body p-0">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Дата и время</th>
                                <th>Врач</th>
                                <th>Специализация</th>
                                <th>Причина</th>
                                <th>Статус</th>
                                <th class="text-end">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                var isCancelled = item.Status == ClinicApp.Models.Core.AppointmentStatus.Cancelled;
                                var rowClass = isCancelled ? "table-secondary text-muted" : "";
                                bool isPast = item.AppointmentDateTime < DateTime.Now;
                                bool isExpired = isPast && (item.Status == ClinicApp.Models.Core.AppointmentStatus.Scheduled || item.Status == ClinicApp.Models.Core.AppointmentStatus.Confirmed);

                                <tr class="@rowClass">
                                    <td class="fw-bold">
                                        @item.AppointmentDateTime.ToString("dd.MM.yyyy")
                                        <span class="text-primary ms-1">@item.AppointmentDateTime.ToString("HH:mm")</span>
                                    </td>
                                    <td>@(item.Doctor?.User?.FullName ?? "Неизвестно")</td>
                                    <td>
                                        <span class="badge bg-light text-dark border">
                                            @(item.Doctor?.Specialization?.Name ?? "-")
                                        </span>
                                    </td>
                                    <td class="text-truncate" style="max-width: 200px;" title="@item.Reason">@item.Reason</td>
                                    <td>
                                        @switch (item.Status)
                                        {
                                            case ClinicApp.Models.Core.AppointmentStatus.Scheduled:
                                                if (isExpired)
                                                {
                                                    <span class="badge bg-secondary text-white" title="Прием не состоялся или врач не закрыл запись">
                                                        <i class="fas fa-clock me-1"></i>Не состоялся
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-primary">Запланировано</span>
                                                }
                                                break;
                                            case ClinicApp.Models.Core.AppointmentStatus.Confirmed:
                                                if (isExpired)
                                                {
                                                    <span class="badge bg-secondary text-white">Не закрыт</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-success">Подтверждено</span>
                                                }
                                                break;
                                            case ClinicApp.Models.Core.AppointmentStatus.InProgress:
                                                if (isPast)
                                                {
                                                    <span class="badge bg-warning text-dark border border-warning" title="Врач забыл завершить прием">
                                                        <i class="fas fa-exclamation-circle me-1"></i>Не закрыт врачом
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning text-dark">Идет прием</span>
                                                }
                                                break;
                                            case ClinicApp.Models.Core.AppointmentStatus.Completed:
                                                <span class="badge bg-secondary"><i class="fas fa-check me-1"></i>Завершено</span>
                                                break;
                                            case ClinicApp.Models.Core.AppointmentStatus.Cancelled:
                                                <span class="badge bg-danger"><i class="fas fa-times me-1"></i>Отменено</span>
                                                break;
                                            case ClinicApp.Models.Core.AppointmentStatus.NoShow:
                                                <span class="badge bg-dark">Неявка</span>
                                                break;
                                            default:
                                                <span class="badge bg-light text-dark border">@item.Status</span>
                                                break;
                                        }
                                    </td>
                                    <td class="text-end">
                                        @if (item.Status == ClinicApp.Models.Core.AppointmentStatus.Scheduled ||
                                                                        item.Status == ClinicApp.Models.Core.AppointmentStatus.Confirmed)
                                        {
                                            <form action="/Patient/CancelAppointment" method="post"
                                                  onsubmit="return confirm('Вы уверены, что хотите отменить запись?');" style="display:inline;">
                                                @Html.AntiForgeryToken()

                                                <input type="hidden" name="appointmentId" value="@item.Id" />
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Отменить запись">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </form>
                                        }
                                        else if (item.Status == ClinicApp.Models.Core.AppointmentStatus.Completed)
                                        {
                                            <a href="/Patient/MedicalRecords" class="btn btn-sm btn-outline-info" title="Смотреть результат">
                                                <i class="fas fa-file-medical"></i>
                                            </a>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center p-5 text-muted">
                    @if (currentTab == "upcoming")
                    {
                        <i class="fas fa-calendar-day fa-3x mb-3 text-primary opacity-25"></i>
                        <h5>Нет предстоящих записей</h5>
                        <p>Самое время записаться к врачу!</p>
                        <a href="/Patient/CreateAppointment" class="btn btn-primary mt-2">Записаться</a>
                    }
                    else
                    {
                        <i class="fas fa-history fa-3x mb-3 text-secondary opacity-25"></i>
                        <h5>История пуста</h5>
                        <p>Здесь будут храниться ваши прошедшие визиты.</p>
                    }
                </div>
            }
        </div>
    </div>
</div>